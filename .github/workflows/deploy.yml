name: Build and Deploy K-Resolver

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy'
        required: false
        default: 'false'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write

env:
  REGISTRY: docker.quetta-soft.com
  IMAGE: docker.quetta-soft.com/yunsung/k-resolver
  PLATFORMS: linux/amd64,linux/arm64

jobs:
  build-and-push:
    name: Build and push Docker image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Registry (with retry)
        run: |
          MAX_ATTEMPTS=3
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS to login to Docker registry..."

            if echo "${{ secrets.DOCKER_PASSWORD }}" | docker login ${{ env.REGISTRY }} \
              --username "${{ secrets.DOCKER_USERNAME }}" \
              --password-stdin; then
              echo "Successfully logged in to Docker registry"
              break
            else
              echo "Login attempt $ATTEMPT failed"
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                echo "Waiting 10 seconds before retry..."
                sleep 10
              else
                echo "All login attempts failed"
                exit 1
              fi
            fi
            ATTEMPT=$((ATTEMPT + 1))
          done

      - name: Compute tags
        id: tags
        run: |
          BRANCH="${{ github.ref_name }}"
          SHA7="${{ github.sha }}"
          SHORT="${SHA7:0:7}"

          if [[ "${BRANCH}" == "main" ]]; then
            echo "TAGS=${{ env.IMAGE }}:${SHORT},${{ env.IMAGE }}:latest" >> "$GITHUB_ENV"
          else
            SAFE_BRANCH="${BRANCH//\//-}"
            echo "TAGS=${{ env.IMAGE }}:${SAFE_BRANCH}-${SHORT}" >> "$GITHUB_ENV"
          fi
          echo "Using tags: $TAGS"

      - name: Build and push multi-platform Docker image
        env:
          DOCKER_BUILDKIT: "1"
        run: |
          set -euo pipefail

          # Dockerfile í™•ì¸
          if [ ! -f "Containerfile" ]; then
            echo "Error: Containerfile not found"
            exit 1
          fi

          # íƒœê·¸ ë°°ì—´ë¡œ ë³€í™˜
          IFS=',' read -ra TAG_ARRAY <<< "$TAGS"

          # buildxë¥¼ ì‚¬ìš©í•˜ì—¬ ë©€í‹°í”Œë«í¼ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
          BUILD_CMD="docker buildx build --platform ${{ env.PLATFORMS }} --push -f Containerfile"

          # ê° íƒœê·¸ ì¶”ê°€
          for tag in "${TAG_ARRAY[@]}"; do
            BUILD_CMD="$BUILD_CMD -t $tag"
          done

          BUILD_CMD="$BUILD_CMD ."

          echo "Building with command: $BUILD_CMD"
          eval $BUILD_CMD

  deploy-to-server:
    name: Deploy to server
    needs: build-and-push
    runs-on: [self-hosted, k-resolver]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment directory
        run: |
          mkdir -p /data/k-resolver

      - name: Copy compose file
        run: |
          cp compose.yml /data/k-resolver/
          cp .env.example /data/k-resolver/.env.example

          # .env íŒŒì¼ì´ ì—†ìœ¼ë©´ exampleë¡œ ìƒì„±
          if [ ! -f /data/k-resolver/.env ]; then
            cp .env.example /data/k-resolver/.env
            echo "âš ï¸  .env íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”."
          fi

      - name: Pull and restart containers
        run: |
          cd /data/k-resolver

          # ì´ë¯¸ì§€ í’€
          podman-compose pull api || docker-compose pull api

          # ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
          podman-compose up -d || docker-compose up -d

          # í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°
          echo "Waiting for service to be healthy..."
          sleep 10

          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          curl -f http://localhost:8000/health || echo "âš ï¸  Health check failed"

      - name: Run database migrations
        run: |
          cd /data/k-resolver

          # ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
          podman-compose exec -T api alembic upgrade head || \
          docker-compose exec -T api alembic upgrade head

          echo "âœ… Database migrations completed"

      - name: Seed data if needed
        run: |
          cd /data/k-resolver

          # ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì‹œë“œ ì‹¤í–‰ (ì„ íƒì‚¬í•­)
          echo "Run 'podman-compose exec api python scripts/seed_data.py' manually if needed"

  notify-success:
    name: Notify deployment success
    needs: [build-and-push, deploy-to-server]
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Send success notification to Slack
        if: ${{ secrets.SLACK_WEBHOOK != '' }}
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "âœ… K-Resolver ë°°í¬ ì„±ê³µ!",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸš€ K-Resolver ë°°í¬ ì„±ê³µ",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*í”„ë¡œì íŠ¸:*\nK-Resolver"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ë¸Œëœì¹˜:*\n`${{ github.ref_name }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ì»¤ë°‹:*\n`${{ github.sha }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ë°°í¬ì:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ì»¤ë°‹ ë©”ì‹œì§€:*\n${{ github.event.head_commit.message }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "GitHub Actions ë³´ê¸°",
                        "emoji": true
                      },
                      "url": "${{ github.event.repository.html_url }}/actions/runs/${{ github.run_id }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ì»¤ë°‹ ë³´ê¸°",
                        "emoji": true
                      },
                      "url": "${{ github.event.repository.html_url }}/commit/${{ github.sha }}"
                    }
                  ]
                }
              ]
            }'

  notify-failure:
    name: Notify deployment failure
    needs: [build-and-push, deploy-to-server]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Send failure notification to Slack
        if: ${{ secrets.SLACK_WEBHOOK != '' }}
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "âŒ K-Resolver ë°°í¬ ì‹¤íŒ¨!",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "âš ï¸ K-Resolver ë°°í¬ ì‹¤íŒ¨",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*í”„ë¡œì íŠ¸:*\nK-Resolver"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ë¸Œëœì¹˜:*\n`${{ github.ref_name }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ì»¤ë°‹:*\n`${{ github.sha }}`"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸ”´ *ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!*"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ğŸ” ë¡œê·¸ í™•ì¸",
                        "emoji": true
                      },
                      "style": "danger",
                      "url": "${{ github.event.repository.html_url }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }'
